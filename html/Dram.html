<!-- start content -->
			<p><b>Block:</b> DRAM (<code>dram</code>)<br />
<b>Block Author</b>: Pierre Yves Droz (BEE2), David George(ROACH)<br />
<b>Document Author</b>: Jason Manley, Laura Spitler<br />
</p>
<table id="toc" class="toc"><tr><td><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Summary"><span class="tocnumber">1</span> <span class="toctext">Summary</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="#Mask_Parameters"><span class="tocnumber">2</span> <span class="toctext">Mask Parameters</span></a></li>
<li class="toclevel-1 tocsection-3"><a href="#Ports"><span class="tocnumber">3</span> <span class="toctext">Ports</span></a></li>
<li class="toclevel-1 tocsection-4"><a href="#Description"><span class="tocnumber">4</span> <span class="toctext">Description</span></a>
<ul>
<li class="toclevel-2 tocsection-5"><a href="#BEE2_Specific_Info"><span class="tocnumber">4.1</span> <span class="toctext">BEE2 Specific Info</span></a>
<ul>
<li class="toclevel-3 tocsection-6"><a href="#Addressing"><span class="tocnumber">4.1.1</span> <span class="toctext">Addressing</span></a></li>
<li class="toclevel-3 tocsection-7"><a href="#Data_bus_width"><span class="tocnumber">4.1.2</span> <span class="toctext">Data bus width</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-8"><a href="#ROACH_Specific_Info"><span class="tocnumber">4.2</span> <span class="toctext">ROACH Specific Info</span></a>
<ul>
<li class="toclevel-3 tocsection-9"><a href="#Interfacing_Details"><span class="tocnumber">4.2.1</span> <span class="toctext">Interfacing Details</span></a></li>
<li class="toclevel-3 tocsection-10"><a href="#DRAM_CPU_interface"><span class="tocnumber">4.2.2</span> <span class="toctext">DRAM CPU interface</span></a></li>
<li class="toclevel-3 tocsection-11"><a href="#Example_models"><span class="tocnumber">4.2.3</span> <span class="toctext">Example models</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-12"><a href="#Performance_Tips"><span class="tocnumber">4.3</span> <span class="toctext">Performance Tips</span></a></li>
</ul>
</li>
</ul>
</td></tr></table><script>if (window.showTocToggle) { var tocShowText = "show"; var tocHideText = "hide"; showTocToggle(); } </script>
<h2> <span class="mw-headline" id="Summary"> Summary </span></h2>
<p>This block interfaces to the BEE2+ROACH's 1GB DDR2 ECC DRAM modules. Commands that are clocked-in are executed with an unknown delay, however, execution order is maintained. The underlying controller for the BEE2 and the ROACH are different and not all features are supported across both platforms (see below for details).
</p>
<h2> <span class="mw-headline" id="Mask_Parameters"> Mask Parameters </span></h2>
<table width="500" border="1" cellpadding="3">
<tr>
<th> Parameter
</th><th> Variable
</th><th> Description
</th></tr>
<tr>
<td> DIMM
</td><td> dimm
</td><td> Selects which physical DIMM to use (four per user FPGA).
</td></tr>
<tr>
<td> Data Type
</td><td> arith_type
</td><td> Inform Simulink how it should interpret the stored data.
</td></tr>
<tr>
<td> Data binary point
</td><td> bin_pt
</td><td> Inform Simulink how it should interpret the stored data - specifically, the bit position in the word where it should place the binary point.
</td></tr>
<tr>
<td> Datapath clock rate (MHz)
</td><td> ip_clock
</td><td> Clock rate for DRAM. Default: 200MHz (400DDR).
</td></tr>
<tr>
<td> Sample period
</td><td> sample_period
</td><td> Is significant for clocking the block. Default: 1
</td></tr>
<tr>
<td> Simulate DRAM using ModelSim
</td><td> use_sim
</td><td> Requires the addition of the ModelSim block at the top level of the design. Used to simulate DRAM block only.
</td></tr>
<tr>
<td> Lesser Simulation Address Width
</td><td>&nbsp;???
</td><td> If the ModelSim simulation is disabled a very basic simulation using BRAMs will be performed. This parameter selects the address width to the bram memory and cannot exceed 20 (or so) bits.
</td></tr>
<tr>
<td> Enable bank management
</td><td> bank_mgt
</td><td> <i>Advise leave off for BEE2.</i> Allows multiple banks to be open at the same time. <i>Always enabled on ROACH (setting ignored).</i>
</td></tr>
<tr>
<td> Use wide data bus (288 bits)
</td><td> wide_data
</td><td> Burst writes require 288 bits. If not selected, provide a 144 bit bus which needs to be supplied with data in consecutive clock cycles to form the 288 bits. 288 bit bus can make for challenging routing! <i>Not implemented on ROACH.</i>
</td></tr>
<tr>
<td> Use half-burst
</td><td> half_burst
</td><td> Only store 144 bits per burst (wastes half capacity as the second 144 bits are unusable). If enabled, requires at least two clock cycles to store 144 bits. Second clock cycle's data is forfeited. <i>Not implemented on ROACH.</i>
</td></tr>
<tr>
<td> Use BRAM FIFOs <br /> <i>(ROACH only)</i>
</td><td> <span class="textit">bram_fifos</span>
</td><td> Use blockRAM FIFO's in DRAM controller. This is required only if the application clock rate is less than the dram clock rate to avoid overflows on the read interface. By default distributed RAM will be used which exhibits better timing performance and reduces BRAM resources.
</td></tr>
<tr>
<td> Include CPU Interface <br /> <i>(ROACH only)</i>
</td><td> use_sniffer
</td><td> Includes the CPU interface which allows direct DRAM access from software. Including this may introduce timing issues at very high DRAM controller frequencies.
</td></tr>
</table>
<h2> <span class="mw-headline" id="Ports"> Ports </span></h2>
<table width="500" border="1" cellpadding="3">
<tr>
<th> Port
</th><th> Dir
</th><th> Data Type
</th><th> Description
</th></tr>
<tr>
<td> rst
</td><td> in
</td><td> boolean
</td><td> Resets the block when pulsed high
</td></tr>
<tr>
<td> address
</td><td> in
</td><td> UFix_32_0
</td><td> A signal which accepts the address. See below for details.
</td></tr>
<tr>
<td> data_in
</td><td> in
</td><td> 144 or 288 bit unsigned
</td><td> Accepts data to be saved to DRAM.
</td></tr>
<tr>
<td> wr_be
</td><td> in
</td><td> UFix_18_0 or UFix_36_0
</td><td> Selects bytes for writing (write byte enable). It is normally 18 bits wide for a 144 bit data bus, but if 288 bit data bus is selected, this becomes a 36 bit variable.
</td></tr>
<tr>
<td> RWn
</td><td> in
</td><td> boolean
</td><td> Selects read or not-write. <code>1</code> for read, <code>0</code> for write.
</td></tr>
<tr>
<td> cmd_tag
</td><td> in
</td><td> UFix_32_0
</td><td> Accepts a user-defined tag for labelling entered commands. <i>Not implemented on ROACH.</i>
</td></tr>
<tr>
<td> cmd_valid
</td><td> in
</td><td> boolean
</td><td> Clocks data into the command buffer.
</td></tr>
<tr>
<td> rd_ack
</td><td> out
</td><td> boolean
</td><td> Used to acknowledge that the last <code>data_out</code> value has been read.
</td></tr>
<tr>
<td> cmd_ack
</td><td> out
</td><td> boolean
</td><td> Acknowledges that the last command was accepted (when buffer is full, will not accept additional commands).
<p>ROACH: Pin HI unless an attempt to clock in a command failed
</p>
</td></tr>
<tr>
<td> data_out
</td><td> out
</td><td> UFix_144_0
</td><td> Outputs data from DRAM, 144 bits at a time. Reads are in groups of 288 bits (ie, 2 clocks).
</td></tr>
<tr>
<td> rd_tag
</td><td> out
</td><td> UFix_32_0
</td><td> Outputs the identifier for the data on <code>data_out</code> (as submitted on <code>cmd_tag</code> when the command was issued). <i>Not implemented on ROACH.</i>
</td></tr>
<tr>
<td> rd_valid
</td><td> out
</td><td> boolean
</td><td> Indicates that the data on <code>data_out</code> is valid.
</td></tr>
</table>
<h2> <span class="mw-headline" id="Description"> Description </span></h2>
<h3> <span class="mw-headline" id="BEE2_Specific_Info"> BEE2 Specific Info </span></h3>
<p>Core details about the BEE2 memory interface can be found at the (static) BEE2 wiki:
</p><p><a href="http://bee2.eecs.berkeley.edu/wiki/Bee2Memory.html" class="external free" rel="nofollow">http://bee2.eecs.berkeley.edu/wiki/Bee2Memory.html</a>
</p>
<h4> <span class="mw-headline" id="Addressing"> Addressing </span></h4>
<p>The 1GB storage DIMMs have 18 512Mbit chips each. They are arranged as 64Mbit x 8 (bus width) x 9 (chips per side/rank) x 2 (sides/ranks). Two ranks (sides) per module with the 9 memory ICs connected in parallel, each holding 8 bits of the data bus width (72 bits). Each IC has four banks, with 13 bits of row addressing and 10 bits for column addressing. Normally, each address would hold 64 bits + parity (8 bits), however, the BEE2 uses the parity space as additional data storage giving a capacity of 1.125 GB per DIMM module.
</p><p>From Micron's datasheet on the <i>MT47H64M8CD-37E</i> (as used by CASPER in its Crucial 1GB <i>CT12872AA53E</i> modules): The double data rate architecture is essentially a 4n-prefetch architecture, with an interface designed to transfer two data words per clock cycle at the I/O balls. A single read or write access effectively consists of a single 4n-bit-wide, one-clock-cycle data transfer at the internal DRAM core and four corresponding n-bit-wide, one-half-clock-cycle data transfers at the I/O balls.
</p><p>Reads and writes must thus occur four-at-a-time. 4 x 72bits = 288 bits. Although the mapping of the logical to physical addressing is abstracted from the user, it is useful to know how the DRAM block's address bus is derived, as it impacts performance:
</p>
<table align="center" border="1" cellpadding="3">
<tr>
<th> Addressing
</th><th> Assignment
</th></tr>
<tr>
<td> Column
</td><td> 12 <img class="tex" alt="\rightarrow" src="images/math/8/3/e/83e37b7246fdfcb99b2754210ebeae27.png" /> 3
</td></tr>
<tr>
<td> Rank
</td><td> 13
</td></tr>
<tr>
<td> Row
</td><td> 27 <img class="tex" alt="\rightarrow" src="images/math/8/3/e/83e37b7246fdfcb99b2754210ebeae27.png" /> 14
</td></tr>
<tr>
<td> Bank
</td><td> 29 <img class="tex" alt="\rightarrow" src="images/math/8/3/e/83e37b7246fdfcb99b2754210ebeae27.png" /> 28
</td></tr>
<tr>
<td> not used
</td><td> 31 <img class="tex" alt="\rightarrow" src="images/math/8/3/e/83e37b7246fdfcb99b2754210ebeae27.png" /> 30
</td></tr>
<caption style="caption-side: bottom"> Address bit assignments
</caption></table>
<p>Each group of 8 addresses selects a 144 bit logical location (the lowest 3 bits are ignored). For example, address <code>0x00</code> through <code>0x7</code> all address the same 144 bit location. To address consecutive locations, increment the address port by eight. There are thus a total of <span class="texhtml">2<sup>27</sup></span> possible addresses. The block supports 2GB DIMMs (UNCONFIRMED) since 14 bits of addressing are reserved for row selection. The 1GB DIMMs using Micron 512Mb chips, however, only use 13 bits for row selection which results in <span class="texhtml">2<sup>26</sup></span> possible address locations. Care should be taken when addressing the 1GB DIMMS as bit 27 of the address range is not valid. However, bits 28 and 29 are mapped. Since bit 27 is ignored, it results in overlapping memory spaces.
</p>
<h4> <span class="mw-headline" id="Data_bus_width"> Data bus width </span></h4>
<p>The BEE2 uses ECC DRAM, however, the parity bits are used for data storage rather than parity storage. Thus, the data bus is 72 bits wide instead of the usual 64 bits.
</p><p>The memory module has a DDR interface requiring two reads or writes per RAM clock cycle (~200MHz), thus requiring the user to provide 144 bits per clock cycle. Furthermore, as outlined above, data has to be captured in batches of 288 bits. This can be done in one of two ways: in two consecutive blocks of 144 bits, or over a single 288 bit-wide bus. This is selectable as a mask parameter. If half-burst is selected, only a 144 bit input is required. 288 bits are still written to DRAM, but the second 144 bits are not specified. Thus, half of the DRAM capacity is unusable.
</p>
<h3> <span class="mw-headline" id="ROACH_Specific_Info"> ROACH Specific Info </span></h3>
<p>The ROACH DRAM infrastructure currently doesn't support half burst and wide data modes. Bank management is always enabled. Tag buffers are not implemented. The DRAM controller clock rate can be one of the following: 150, 200, 266, 300 or 333. If a frequency other than these is provided the default of 266 will be used. The dram controller has been known to work at 300MHz.
</p>
<h4> <span class="mw-headline" id="Interfacing_Details"> Interfacing Details </span></h4>
<p>To write data into the DRAM, 'RWn' is held low, 'cmd_valid' is held high for a minimum of two FPGA clocks, and the 'address' port is held constant for both clock cycles. For example, to write into addresses 0x00 and 0x01, keep the address at 0x00 for both clocks. To read data out of the DRAM, hold 'RWn' high, keep the address constant for two FPGA clock cycles, and toggle the 'cmd_valid' pin every clock. Note that a new word will be available on the 'data_out' pin on every clock cycle. 'rd_valid' will frame valid output data some indeterminate number of clock cycles after the read 'cmd_valid' toggles. 'cmd_ack' is high unless an attempt to write a command into the input FIFO failed, at which point it will go low synchronously with the issuing of the failed command.
</p><p>Many ROACHs have been shipped with 1 GB dual rank DIMMs by default. The current DRAM controller is not able to handle multiple ranks, so when a dual-rank DIMM is installed on the board, only half the memory is available. In order to use the full 1 GB, a single rank DIMM is needed, or in principle a dual rank 2 GB module.
</p><p>Note that on the ROACH all of the oddities of the DRAM addressing specified above for the BEE2 version are taken care of for  you, so you can just directly address locations 0 to (2^30 / 16) = 2^26 in the hardware.
</p>
<h4> <span class="mw-headline" id="DRAM_CPU_interface"> DRAM CPU interface </span></h4>
<p>If the block mask was set to include the CPU interface, the DRAM can be accessed by bytes through BORPH through 'dram_memory'. The width of the CPU interface is only 128 bits (16 bytes), which results in discrepancy between hardware and CPU address. After every 64 bits, there are 8 ECC bits not visible to the CPU. For example bytes 0x00-0x07 in the DRAM are seen as 0x00-0x07 in the CPU, byte 0x08 in the DRAM is not visible to the CPU, and byte 0x09 in the DRAM is seen as byte 0x08 in the CPU. 
</p><p>Only 64MB of DRAM can be mapped into the 'dram_memory' register at any given time. You can select which 64MB segment is mapped into the 'dram_memory' register though the first 32-bit word of the 'dram_controller' register. For example, to access the first 64MB chunk of DRAM write 0x0 into this register and for the second 0x1.
</p><p>The DRAM is most easily accessed using the KATCP function "read_dram".
</p><p>The second 32-bit word in the 'dram_controller' register indicates the DRAM controller ready flag. This value stores will be 0x1 if the controller is operational. If it is not your DRAM will not operate at all. Typical problems causing this would include using an unsupported RDIMM. 
</p><p><br />
</p>
<h4> <span class="mw-headline" id="Example_models"> Example models </span></h4>
<p>1) David George's million channel ROACH spectrometer ("buf" block): <a href="http://casper.berkeley.edu/svn/trunk/projects/roach_mspec/mdls/rmspec.mdl" class="external text" rel="nofollow">rmspec.mdl</a>
</p><p>2) Laura Spitler's simple design that reads and writes a counter into the DRAM: <a href="/wiki/File:Dram_roach_rwramp.mdl" title="File:Dram roach rwramp.mdl">File:Dram roach rwramp.mdl</a>
</p><p>3) Jason Manley's DRAM counter example: <a href="/wiki/File:Dram_counter_test_10_1.gz" title="File:Dram counter test 10 1.gz">File:Dram counter test 10 1.gz</a>
</p><p>4) Tim Madden's DRAM streaming output design (April 2015) <a href="https://github.com/argonnexraydetector/RoachFirmPy" class="external free" rel="nofollow">https://github.com/argonnexraydetector/RoachFirmPy</a>
</p>
<h3> <span class="mw-headline" id="Performance_Tips"> Performance Tips </span></h3>
<p>The performance of the DRAM block is dependent on the relative location of the addressed data and whether or not the mode (read/write) is changed. For example, consecutive column addresses can be written without delay, however, changing rows or banks incur delay penalties. See above for the address bit assignment.
</p><p>To obtain optimum performance, it is recommended that the least significant bits be changed first (ie address the memory from <code>0x0000000</code> through to address <code>0x20000000</code> on the BEE2). This will increment column addresses first, followed by rank change, both of which incur little delay. Changing rows or banks can take twice as long. Further information can be found in the DRAM module's datasheet (Micron <i>MT47H64M8</i> on the BEE2).
</p><p>Changing the mode(read/write) results in large delays, so it is recommended that read and writes be done in bursts into consecutive addresses. For a fabric clock speed of 200 MHz and DRAM speed of 266 MHz, a burst length of at least 32 words is recommended. 
</p><p>Bank management allows for three banks to be open simultaneously, reducing the overhead when switching between these banks. This feature is always enabled on ROACH, but YMMV with the BEE2 controller.
</p>